name: Email Cleaner

on:
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9" # Specify the Python version

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_email_cleaner.txt

    - name: Run email cleaner script
      env:
        EMAIL_H4: ${{ secrets.EMAIL_H4 }}
        EMAIL_H4_PASSWORD: ${{ secrets.EMAIL_H4_PASSWORD }}
      run: |
        python email_cleaner.py

    - name: List files in the directory
      run: ls -l

    - name: Find and Upload CSV file
      run: |
        # Find the CSV file generated by the script
        CSV_FILE=$(ls unsubscribe_links_*.csv 2>/dev/null | head -n 1 || true)
        if [ -z "$CSV_FILE" ]; then
          echo "No CSV file found. Exiting gracefully."
          exit 0
        fi
        echo "Found CSV file: $CSV_FILE"
        echo "CSV_FILE=$CSV_FILE" >> $GITHUB_ENV
      shell: bash

    - name: Upload CSV file
      if: env.CSV_FILE != '' # Only run if a CSV file was found
      uses: actions/upload-artifact@v3
      with:
        name: unsubscribe_links
        path: ${{ env.CSV_FILE }}
